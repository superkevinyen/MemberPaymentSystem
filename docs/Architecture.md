# MPS Architecture

---

## 系統角色 (System Roles)

| Role         | 說明 |
|--------------|----------------------------|
| super_admin  | 平台最高管理員，可操作所有模組 |
| admin        | 平台運營管理員，限會員/卡片管理 |
| merchant     | 商戶操作員，可收款、退款、查詢 |
| member       | 普通會員，僅能管理自身卡片 |

---

## 卡片類型 (Card Types)

| 類型        | 說明 | 積分 | 折扣 | 綁定 | QR Code |
|-------------|------|------|------|------|---------|
| standard    | 自動生成，單人專屬 | ✅ | 隨等級變化 | 一對一 | 每次交易動態生成 |
| prepaid     | 儲值卡，多人共享 | ✅ | 升級不降級 | 一對多（密碼綁定） | 系統每 5 分鐘自動生成 |
| voucher     | 一次性優惠券 | ❌ | 固定折扣 | 一對一 | 單次有效 |
| corporate   | 企業/聯名卡 | ❌ | 固定折扣 | 一對多 | 批次生成 |

---

## 卡片角色 (Card Bindings)

| Role   | 說明 |
|--------|----------------------------|
| owner  | 卡片發行人/持有人 |
| admin  | 卡片管理員，可邀請或移除綁定者 |
| member | 共用成員，可消費 |
| viewer | 僅查詢，不可消費 |

---

## ERD (實體關聯圖)

![ERD](./mps_erd.png)

---

## 支付流程 (時序圖)

![支付流程](./mps_sequence.png)

---

## 角色權限矩陣

![角色矩陣](./roles_matrix.png)

---

## 結算模式

- **Realtime**：交易完成即入帳，立即可用  
- **T+1**：每日 CRON 對帳，隔天入帳  
- **Monthly**：每月一次結算，適合發票/稅務  

👉 可透過 `settlements` 表定義結算策略

---

## 安全與合規
- 所有金流表格啟用 **RLS**（Row Level Security）  
- 寫入操作僅允許 **SECURITY DEFINER RPCs**  
- `audit.event_log` 全量追蹤敏感操作  
