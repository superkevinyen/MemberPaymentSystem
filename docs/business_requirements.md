# MPS 業務需求規格書

## 1. 項目概述

### 1.1 項目背景
Member Payment System (MPS) 是一個企業級會員支付系統，旨在為零售、餐飲、服務業等行業提供完整的會員管理和支付解決方案。

### 1.2 項目目標
- 提供多類型會員卡管理功能
- 支持 QR 碼掃碼支付
- 實現積分等級體系
- 提供完整的交易和結算功能
- 支持多種外部身份綁定
- 確保系統安全性和可擴展性

### 1.3 目標用戶
- **會員用戶**: 使用 App/小程序進行支付、充值、查看積分等
- **商戶用戶**: 使用 POS 系統進行收款、退款、查看交易記錄
- **平台管理員**: 管理會員、商戶、進行風控操作

## 2. 功能需求

### 2.1 會員管理模組

#### 2.1.1 會員註冊與登入
**需求描述**: 支持會員通過多種方式註冊和登入系統

**功能要求**:
- 支持手機號、郵箱註冊
- 支持微信、支付寶、Line 等第三方登入
- 自動生成會員編號和標準卡
- 支持外部身份綁定和解綁

**業務規則**:
- 每個會員必須有唯一的會員編號
- 每個會員自動獲得一張標準卡
- 外部身份與會員一對一綁定
- 支持一個會員綁定多個外部身份（不同平台）

**驗收標準**:
- 註冊成功後自動生成標準卡
- 外部身份綁定不能重複
- 會員狀態可以是：active, inactive, suspended, deleted

#### 2.1.2 會員資料管理
**需求描述**: 會員可以查看和更新個人資料

**功能要求**:
- 查看個人基本資料
- 更新聯絡資訊
- 查看綁定的外部身份
- 查看擁有的卡片列表

### 2.2 卡片管理模組

#### 2.2.1 多類型卡片支持
**需求描述**: 系統支持四種不同類型的卡片

**卡片類型定義**:

| 卡片類型 | 中文名稱 | 特性 | 共享性 | 密碼保護 | 積分累積 | 充值功能 |
|---------|---------|------|--------|----------|----------|----------|
| standard | 標準卡 | 個人身份卡，註冊自動生成 | ❌ | ❌ | ✅ | ❌ |
| prepaid | 預付卡 | 可充值的儲值卡 | ✅ | ✅ | ✅ | ✅ |
| corporate | 企業卡 | 企業發行的共享卡 | ✅ | ✅ | ❌ | ✅ |
| voucher | 優惠券卡 | 一次性優惠券 | ❌ | ❌ | ❌ | ❌ |

**業務規則**:
- 標準卡：每個會員必須且只能有一張，不可共享
- 預付卡：可多人共享，需要密碼綁定，支持積分累積
- 企業卡：可多人共享，需要密碼或授權，不累積個人積分
- 優惠券卡：單次使用，有過期時間

#### 2.2.2 卡片綁定與共享
**需求描述**: 支持會員綁定和共享不同類型的卡片

**功能要求**:
- 會員可以綁定多張卡片
- 支持四種綁定角色：owner, admin, member, viewer
- 共享卡片需要密碼驗證
- 支持解綁功能（保護最後一個 owner）

**角色權限定義**:

| 角色 | 支付 | 充值 | 查看餘額 | 查看交易 | 邀請成員 | 設置密碼 |
|------|------|------|----------|----------|----------|----------|
| owner | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| admin | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| member | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| viewer | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ |

### 2.3 QR 碼支付模組

#### 2.3.1 QR 碼生成與管理
**需求描述**: 為每張卡片生成動態 QR 碼用於支付

**功能要求**:
- 動態生成 QR 碼，設置過期時間
- 支持手動刷新 QR 碼
- 支持撤銷 QR 碼
- 記錄 QR 碼使用歷史

**技術要求**:
- QR 碼明文不存儲，只存儲 bcrypt hash
- 默認 TTL 為 15 分鐘（可配置）
- 支持批量輪換（企業卡、預付卡）

#### 2.3.2 掃碼支付流程
**需求描述**: 商戶通過掃描會員 QR 碼完成支付

**流程步驟**:
1. 會員出示 QR 碼
2. 商戶掃描並輸入金額
3. 系統驗證 QR 碼有效性
4. 檢查卡片狀態和餘額
5. 計算折扣和最終金額
6. 扣除餘額並記錄交易
7. 更新積分和等級
8. 返回支付結果

**業務規則**:
- QR 碼過期自動拒絕
- 餘額不足自動拒絕
- 支持冪等性重試
- 所有操作記錄審計日誌

### 2.4 交易管理模組

#### 2.4.1 支付交易
**需求描述**: 處理會員的支付交易

**功能要求**:
- 支持多種支付方式：餘額、現金、微信、支付寶
- 自動計算折扣（基於會員等級）
- 支持交易標籤和備註
- 冪等性保證（防重複扣款）

**折扣計算規則**:
- 標準卡：基於積分等級的動態折扣
- 預付卡：固定折扣或基於積分的動態折扣
- 企業卡：固定折扣或無折扣
- 優惠券卡：不支持支付

#### 2.4.2 退款交易
**需求描述**: 支持商戶對已完成的支付進行退款

**功能要求**:
- 支持全額退款和部分退款
- 支持多次部分退款
- 自動更新原交易狀態
- 退款金額返回原卡片餘額

**業務規則**:
- 只能退款已完成的支付交易
- 退款總額不能超過原交易金額
- 退款後積分不扣除（業務決定）

#### 2.4.3 充值交易
**需求描述**: 會員可以為預付卡和企業卡充值

**功能要求**:
- 支持多種充值方式
- 支持充值金額限制
- 冪等性保證
- 支持外部訂單號映射

**業務規則**:
- 只有預付卡和企業卡支持充值
- 充值金額必須大於 0
- 充值成功立即到賬

### 2.5 積分等級模組

#### 2.5.1 積分累積
**需求描述**: 會員通過消費累積積分

**積分規則**:
- 標準卡和預付卡支持積分累積
- 企業卡和優惠券卡不累積積分
- 積分 = 消費金額（向下取整）
- 退款不扣除已獲得的積分

#### 2.5.2 等級升降
**需求描述**: 基於積分自動調整會員等級

**等級定義**:
| 等級 | 名稱 | 積分範圍 | 折扣率 |
|------|------|----------|--------|
| 0 | 普通會員 | 0-999 | 100% |
| 1 | 銀卡會員 | 1000-4999 | 95% |
| 2 | 金卡會員 | 5000-9999 | 90% |
| 3 | 鑽石會員 | 10000+ | 85% |

**業務規則**:
- 積分增加時自動升級
- 積分減少時自動降級
- 等級變更立即生效
- 記錄等級變更歷史

### 2.6 商戶管理模組

#### 2.6.1 商戶註冊與管理
**需求描述**: 平台管理員可以管理商戶資訊

**功能要求**:
- 新增/編輯/停用商戶
- 設置商戶編碼和名稱
- 管理商戶用戶權限
- 查看商戶交易統計

#### 2.6.2 商戶用戶管理
**需求描述**: 管理商戶的操作用戶

**功能要求**:
- 綁定 Supabase Auth 用戶到商戶
- 設置用戶角色和權限
- 支持多個用戶操作同一商戶

### 2.7 結算管理模組

#### 2.7.1 結算生成
**需求描述**: 定期為商戶生成結算報表

**結算模式**:
- **realtime**: 實時結算
- **t_plus_1**: T+1 結算
- **monthly**: 月結算

**功能要求**:
- 自動聚合指定期間的交易
- 計算淨收入（支付 - 退款）
- 生成結算報表
- 支持手動和自動結算

#### 2.7.2 結算查詢
**需求描述**: 商戶可以查看結算歷史

**功能要求**:
- 分頁查詢結算記錄
- 按時間範圍篩選
- 查看結算詳情
- 導出結算報表

### 2.8 風控管理模組

#### 2.8.1 卡片風控
**需求描述**: 支持卡片的風控操作

**功能要求**:
- 凍結/解凍卡片
- 設置卡片過期時間
- 查看卡片使用記錄
- 異常交易監控

#### 2.8.2 會員風控
**需求描述**: 支持會員的風控操作

**功能要求**:
- 暫停/恢復會員
- 查看會員行為記錄
- 設置會員黑名單
- 異常行為預警

#### 2.8.3 商戶風控
**需求描述**: 支持商戶的風控操作

**功能要求**:
- 暫停/恢復商戶
- 查看商戶交易記錄
- 設置交易限額
- 異常交易監控

## 3. 非功能需求

### 3.1 性能需求
- 支付響應時間 < 3 秒
- QR 碼生成時間 < 1 秒
- 系統併發支持 1000+ TPS
- 數據庫查詢響應時間 < 500ms

### 3.2 安全需求
- 所有密碼使用 bcrypt 加密
- QR 碼明文不存儲
- 支持 RLS 行級安全
- 所有敏感操作記錄審計日誌
- 支持 API 訪問控制

### 3.3 可用性需求
- 系統可用性 99.9%
- 支持水平擴展
- 支持數據備份和恢復
- 支持災難恢復

### 3.4 兼容性需求
- 支持 PostgreSQL 12+
- 支持 Supabase 平台
- 支持 Python 3.8+
- 支持 RESTful API

## 4. 業務約束

### 4.1 數據約束
- 會員編號全局唯一
- 卡號全局唯一
- 交易號全局唯一
- 外部身份綁定唯一性

### 4.2 業務約束
- 每個會員必須有一張標準卡
- 共享卡必須有至少一個 owner
- 退款金額不能超過原交易金額
- QR 碼有效期不超過 24 小時

### 4.3 技術約束
- 所有寫操作必須通過 RPC
- 使用 PostgreSQL 事務保證一致性
- 使用諮詢鎖防止併發問題
- 所有金額使用 numeric 類型

## 5. 用例場景

### 5.1 會員註冊場景
1. 用戶打開 App 選擇註冊
2. 輸入手機號和驗證碼
3. 選擇微信登入授權
4. 系統創建會員檔案
5. 自動生成標準卡
6. 綁定微信 openid
7. 註冊完成

### 5.2 掃碼支付場景
1. 會員在 App 中打開付款碼
2. 商戶掃描 QR 碼
3. 輸入支付金額
4. 系統驗證 QR 碼和餘額
5. 計算折扣和最終金額
6. 扣除餘額並增加積分
7. 顯示支付成功

### 5.3 卡片共享場景
1. 企業管理員創建企業卡
2. 設置綁定密碼
3. 分享卡號和密碼給員工
4. 員工輸入卡號和密碼綁定
5. 綁定成功，可以使用企業卡支付

### 5.4 商戶結算場景
1. 系統定時觸發結算任務
2. 聚合商戶指定期間交易
3. 計算淨收入和手續費
4. 生成結算記錄
5. 通知商戶結算完成
6. 商戶查看結算報表

## 6. 驗收標準

### 6.1 功能驗收
- 所有 RPC 函數正常工作
- 所有業務規則正確執行
- 所有錯誤情況正確處理
- 所有審計日誌正確記錄

### 6.2 性能驗收
- 負載測試通過
- 併發測試通過
- 響應時間符合要求
- 資源使用合理

### 6.3 安全驗收
- 安全測試通過
- 權限控制正確
- 數據加密正確
- 審計日誌完整

### 6.4 兼容性驗收
- 多平台測試通過
- API 兼容性測試通過
- 數據遷移測試通過
- 版本升級測試通過