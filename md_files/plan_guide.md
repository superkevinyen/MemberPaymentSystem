# Plan Guide（实施计划 + 里程碑 + 进度）

> 面向产品落地与商业化：以“先网页跑通 → 再抽象 API → 多端接入”为主线。

---

## 1. 阶段划分

### Phase 0. 准备（完成）
- 选型与架构：方案 A（分区内唯一 + 全局注册表 + RPC）。
- 完成 SQL 草案与审计/RLS 设计。

### Phase 1. 后端数据层落地（进行中）
- ✅ 创建 `app` / `audit` / `sec` schema。
- ✅ 审计表 `audit.event_log` 已出现。
- ⏳ `app` 核心表分段执行中（建议按 README 的步骤分段执行，避免回滚）。
- ⏳ RPC 安装（支付/退款/充值/绑定/Qr）。
- ⏳ 启用 RLS。

### Phase 2. Web 管理后台（MVP）
- 商户管理：新增商户、商户成员、退款与对账。
- 会员管理：会员检索、卡片明细、绑定/解绑（企业）。
- 运营工具：等级配置、手工调账（RPC 审计）。

### Phase 3. C 端网页/小程序
- 我的卡片、展示二维码、充值、交易历史。
- 登录与权限联动。

### Phase 4. 商业化 & 可运营
- 促销券、结算周期、对账报表、风控与黑名单、BI 接入。

---

## 2. 页面与任务拆解（Web Admin）

- 登录与角色识别（商户/企业管理员/会员）。
- 商户：列表、详情、成员、收款记录、退款。
- 会员：列表、详情、个人卡、绑定企业卡成员列表。
- 等级配置：CRUD，区间重叠校验提示。
- 对账：按日/月、商户、卡类型、状态过滤导出。

---

## 3. API 对接约定

- 只读：直接 `select` 视图/表（受 RLS 限制）。
- 写入：一律 `supabase.rpc()`。
- 幂等：写操作需自带 `idempotency_key`（例如订单号/随机 UUID）。
- 错误处理：后端抛出的业务异常（如 `INSUFFICIENT_BALANCE`、`QR_EXPIRED_OR_INVALID`、`ONLY_ADMIN_BIND_ALLOWED`）直接展示为可读提示。

---

## 4. 时间线（建议）

| 周期 | 目标 |
|---|---|
| 第 1 周 | 数据库对象全部到位（分段执行通过）；最少端到端链路跑通（注册→发卡→旋转 QR→支付→退款→充值）。 |
| 第 2–3 周 | 管理后台（商户/企业/会员/等级）+ 交易检索页。 |
| 第 4 周 | C 端网页（我的卡、二维码、交易、充值）。 |
| 第 5 周 | 对账与报表、容灾与监控、Edge 定时任务。 |

---

## 5. 风险与缓解

- **一次性执行脚本报错导致回滚** → 采用分段执行与逐步校验。
- **RLS 导致权限拒绝** → 开发环境先不开启写策略，联调后再开启；资金表写入仅 RPC。
- **并发扣款** → 行锁 + advisory 锁；强制 RPC 路径。
- **重复请求** → `idempotency_registry` + 外部订单唯一。

---

## 6. 当前进度快照（根据你环境反馈）

- 数据库 schema：`app` / `audit` / `sec` 已存在。
- 表：目前确认只有 `audit.event_log` 已创建；`app.*` 表尚未完整创建（需要**重新按 README 的分段步骤执行**）。
- 函数：你截图中 `public` 下的函数是历史/示例函数，与本项目无关；请以后端 RPC 为准（在 `app` schema）。
- 下一步：
  1. **按 README Step A~E 分段执行** `mps_full.sql`；每段成功后再执行下一段。
  2. 在 Table Editor 切换 schema = **app** 检查表是否出现。
  3. 跑“最少用例”验证端到端。

---

## 7. 完成定义（DoD）

- 数据层：所有表/视图/RPC/RLS 已部署，月分区存在。
- 功能：注册→发卡→旋转二维码→支付→退款→充值→审计记录链全量通过。
- 运维：定时任务/告警/备份/回滚脚本到位。
- 文档：README/Porting Guide/接口说明/前端接入示例齐全。
