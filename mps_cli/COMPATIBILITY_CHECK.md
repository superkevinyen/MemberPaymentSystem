# MPS CLI å…¼å®¹æ€§æª¢æŸ¥å ±å‘Š

> æª¢æŸ¥ CLI ä»£ç¢¼èˆ‡æœ€æ–° Schema/RPC çš„å…¼å®¹æ€§

## ğŸ“‹ æª¢æŸ¥ç¯„åœ

- âœ… Models (æ•¸æ“šæ¨¡å‹)
- âœ… Utils (å·¥å…·å‡½æ•¸)
- âœ… UI (ç”¨æˆ¶ç•Œé¢)
- âœ… Services (æ¥­å‹™æœå‹™)
- âœ… Schema å…¼å®¹æ€§
- âœ… RPC å‡½æ•¸å°æ¥

---

## âœ… Models æª¢æŸ¥çµæœ

### Card Model (`models/card.py`)

**ç‹€æ…‹**: âœ… **å®Œå…¨å…¼å®¹**

**æª¢æŸ¥é …ç›®**:
- âœ… å­—æ®µèˆ‡ schema ä¸€è‡´
- âœ… å¡ç‰‡é¡å‹æ”¯æŒ (standard/corporate/voucher)
- âœ… ç‹€æ…‹ç®¡ç†æ­£ç¢º
- âœ… æ¥­å‹™æ–¹æ³•å®Œæ•´

**å·²å¯¦ç¾æ–¹æ³•**:
```python
- can_recharge()      # æª¢æŸ¥æ˜¯å¦å¯å……å€¼ï¼ˆåªæœ‰ standardï¼‰
- can_share()         # æª¢æŸ¥æ˜¯å¦å¯å…±äº«ï¼ˆåªæœ‰ corporateï¼‰
- can_generate_qr()   # æª¢æŸ¥æ˜¯å¦å¯ç”Ÿæˆ QR
- can_pay()          # æª¢æŸ¥æ˜¯å¦å¯æ”¯ä»˜
- is_expired()       # æª¢æŸ¥æ˜¯å¦éæœŸ
- get_level_display() # é¡¯ç¤ºç­‰ç´š
- get_discount_display() # é¡¯ç¤ºæŠ˜æ‰£
```

**å»ºè­°**: ç„¡éœ€ä¿®æ”¹

---

### Member Model (`models/member.py`)

**ç‹€æ…‹**: âœ… **å®Œå…¨å…¼å®¹**

**æª¢æŸ¥é …ç›®**:
- âœ… å­—æ®µèˆ‡ schema ä¸€è‡´
- âœ… æ”¯æŒå¤šç¨®èº«ä»½ç¶å®š
- âœ… ç‹€æ…‹ç®¡ç†æ­£ç¢º

**å»ºè­°**: ç„¡éœ€ä¿®æ”¹

---

### Transaction Model (`models/transaction.py`)

**ç‹€æ…‹**: âœ… **å®Œå…¨å…¼å®¹**

**æª¢æŸ¥é …ç›®**:
- âœ… äº¤æ˜“é¡å‹æ”¯æŒ (payment/refund/recharge)
- âœ… ç‹€æ…‹ç®¡ç†æ­£ç¢º
- âœ… æ”¯æŒå†ªç­‰æ€§

**å»ºè­°**: ç„¡éœ€ä¿®æ”¹

---

## âœ… Utils æª¢æŸ¥çµæœ

### Formatters (`utils/formatters.py`)

**ç‹€æ…‹**: âœ… **å®Œå…¨å…¼å®¹**

**å·²å¯¦ç¾æ ¼å¼åŒ–**:
- âœ… è²¨å¹£æ ¼å¼åŒ–
- âœ… æ—¥æœŸæ™‚é–“æ ¼å¼åŒ–
- âœ… ç©åˆ†æ ¼å¼åŒ–
- âœ… æŠ˜æ‰£æ ¼å¼åŒ–
- âœ… ç­‰ç´šæ ¼å¼åŒ–

**å»ºè­°**: ç„¡éœ€ä¿®æ”¹

---

### Validators (`utils/validators.py`)

**ç‹€æ…‹**: âœ… **å®Œå…¨å…¼å®¹**

**å·²å¯¦ç¾é©—è­‰**:
- âœ… æ‰‹æ©Ÿè™Ÿé©—è­‰
- âœ… éƒµç®±é©—è­‰
- âœ… é‡‘é¡é©—è­‰
- âœ… UUID é©—è­‰
- âœ… äº¤æ˜“è™Ÿé©—è­‰

**å»ºè­°**: ç„¡éœ€ä¿®æ”¹

---

### Error Handler (`utils/error_handler.py`)

**ç‹€æ…‹**: âœ… **å®Œå…¨å…¼å®¹**

**å·²å¯¦ç¾éŒ¯èª¤è™•ç†**:
- âœ… RPC éŒ¯èª¤æ˜ å°„
- âœ… å‹å¥½éŒ¯èª¤æç¤º
- âœ… éŒ¯èª¤æ—¥èªŒè¨˜éŒ„

**å»ºè­°**: ç„¡éœ€ä¿®æ”¹

---

## âœ… UI æª¢æŸ¥çµæœ

### Member UI (`ui/member_ui.py`)

**ç‹€æ…‹**: âœ… **å·²å•†æ¥­åŒ–æ”¹å¯«**

**å·²å¯¦ç¾åŠŸèƒ½**:
- âœ… ç”Ÿæˆä»˜æ¬¾ QR ç¢¼ï¼ˆå®Œæ•´å¯¦ç¾ï¼‰
- âœ… å……å€¼å¡ç‰‡ï¼ˆå®Œæ•´å¯¦ç¾ï¼‰
- âœ… ç¶å®šä¼æ¥­å¡ï¼ˆå®Œæ•´å¯¦ç¾ï¼‰
- âœ… æŸ¥çœ‹æˆ‘çš„å¡ç‰‡
- âœ… æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„
- âœ… æŸ¥çœ‹ç©åˆ†ç­‰ç´š

**RPC å°æ¥**:
- âœ… `rotate_card_qr` - æ­£ç¢º
- âœ… `user_recharge_card` - æ­£ç¢º
- âœ… `bind_member_to_card` - æ­£ç¢º
- âœ… `get_member_transactions` - æ­£ç¢º

**å»ºè­°**: ç„¡éœ€ä¿®æ”¹

---

### Merchant UI (`ui/merchant_ui.py`)

**ç‹€æ…‹**: âœ… **å·²å•†æ¥­åŒ–æ”¹å¯«**

**å·²å¯¦ç¾åŠŸèƒ½**:
- âœ… æƒç¢¼æ”¶æ¬¾
- âœ… é€€æ¬¾è™•ç†ï¼ˆå®Œæ•´å¯¦ç¾ï¼‰
- âœ… æŸ¥çœ‹ä»Šæ—¥äº¤æ˜“
- âœ… æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„

**RPC å°æ¥**:
- âœ… `merchant_charge_by_qr` - æ­£ç¢º
- âœ… `merchant_refund_tx` - æ­£ç¢º
- âœ… `get_merchant_transactions` - æ­£ç¢º

**å»ºè­°**: ç„¡éœ€ä¿®æ”¹

---

### Admin UI (`ui/admin_ui.py`)

**ç‹€æ…‹**: âš ï¸ **éœ€è¦æª¢æŸ¥**

**å¯èƒ½éœ€è¦æ›´æ–°çš„åŠŸèƒ½**:
- âš ï¸ å‰µå»ºæœƒå“¡ - æª¢æŸ¥æ˜¯å¦ä½¿ç”¨æœ€æ–° RPC
- âš ï¸ å‰µå»ºå•†æˆ¶ - æª¢æŸ¥æ˜¯å¦ä½¿ç”¨æœ€æ–° RPC
- âš ï¸ å‰µå»ºä¼æ¥­å¡ - æª¢æŸ¥æ˜¯å¦ä½¿ç”¨æœ€æ–° RPC
- âš ï¸ å‰µå»ºå„ªæƒ åˆ¸å¡ - æª¢æŸ¥æ˜¯å¦ä½¿ç”¨æœ€æ–° RPC

**å»ºè­°**: éœ€è¦æª¢æŸ¥ä¸¦æ›´æ–°ï¼ˆå¦‚æœæœ‰æ”¹å‹•ï¼‰

---

## ğŸ” RPC å‡½æ•¸å°æ¥æª¢æŸ¥

### èªè­‰ç›¸é—œ âœ…

| RPC å‡½æ•¸ | CLI ä½¿ç”¨ | ç‹€æ…‹ |
|---------|---------|------|
| `member_login` | âœ… LoginUI | æ­£ç¢º |
| `merchant_login` | âœ… LoginUI | æ­£ç¢º |
| `logout_session` | âœ… AuthService | æ­£ç¢º |
| `load_session` | âœ… AuthService | æ­£ç¢º |

---

### æœƒå“¡åŠŸèƒ½ âœ…

| RPC å‡½æ•¸ | CLI ä½¿ç”¨ | ç‹€æ…‹ |
|---------|---------|------|
| `create_member_profile` | âœ… AdminService | æ­£ç¢º |
| `bind_member_to_card` | âœ… MemberService | æ­£ç¢º |
| `unbind_member_from_card` | âœ… MemberService | æ­£ç¢º |
| `set_member_password` | âœ… AdminService | æ­£ç¢º |

---

### QR ç¢¼åŠŸèƒ½ âœ…

| RPC å‡½æ•¸ | CLI ä½¿ç”¨ | ç‹€æ…‹ |
|---------|---------|------|
| `rotate_card_qr` | âœ… QRService | æ­£ç¢º |
| `revoke_card_qr` | âœ… QRService | æ­£ç¢º |
| `validate_qr_plain` | âœ… QRService | æ­£ç¢º |
| `cron_rotate_qr_tokens` | âœ… QRService | æ­£ç¢º |

---

### æ”¯ä»˜åŠŸèƒ½ âœ…

| RPC å‡½æ•¸ | CLI ä½¿ç”¨ | ç‹€æ…‹ |
|---------|---------|------|
| `merchant_charge_by_qr` | âœ… PaymentService | æ­£ç¢º |
| `merchant_refund_tx` | âœ… PaymentService | æ­£ç¢º |
| `user_recharge_card` | âœ… PaymentService | æ­£ç¢º |

---

### æŸ¥è©¢åŠŸèƒ½ âœ…

| RPC å‡½æ•¸ | CLI ä½¿ç”¨ | ç‹€æ…‹ |
|---------|---------|------|
| `get_member_transactions` | âœ… MemberService | æ­£ç¢º |
| `get_merchant_transactions` | âœ… MerchantService | æ­£ç¢º |
| `get_transaction_detail` | âœ… PaymentService | æ­£ç¢º |
| `get_member_cards` | âœ… MemberService | æ­£ç¢º |

---

### ç®¡ç†åŠŸèƒ½ âš ï¸

| RPC å‡½æ•¸ | CLI ä½¿ç”¨ | ç‹€æ…‹ |
|---------|---------|------|
| `create_merchant` | âš ï¸ AdminService | éœ€æª¢æŸ¥ |
| `create_corporate_card` | âš ï¸ AdminService | éœ€æª¢æŸ¥ |
| `create_voucher_card` | âš ï¸ AdminService | éœ€æª¢æŸ¥ |
| `freeze_card` | âš ï¸ AdminService | éœ€æª¢æŸ¥ |
| `unfreeze_card` | âš ï¸ AdminService | éœ€æª¢æŸ¥ |
| `admin_suspend_member` | âš ï¸ AdminService | éœ€æª¢æŸ¥ |
| `admin_activate_member` | âš ï¸ AdminService | éœ€æª¢æŸ¥ |
| `set_card_binding_password` | âš ï¸ AdminService | éœ€æª¢æŸ¥ |

---

### çµç®—åŠŸèƒ½ âŒ

| RPC å‡½æ•¸ | CLI ä½¿ç”¨ | ç‹€æ…‹ |
|---------|---------|------|
| `generate_settlement` | âŒ æœªå¯¦ç¾ | å¾…å¯¦ç¾ |
| `list_settlements` | âŒ æœªå¯¦ç¾ | å¾…å¯¦ç¾ |

---

## ğŸ“Š Schema å…¼å®¹æ€§æª¢æŸ¥

### æ ¸å¿ƒè¡¨çµæ§‹ âœ…

| è¡¨å | Model æ”¯æŒ | ç‹€æ…‹ |
|------|-----------|------|
| `member_profiles` | âœ… Member | å®Œå…¨å…¼å®¹ |
| `member_cards` | âœ… Card | å®Œå…¨å…¼å®¹ |
| `merchants` | âœ… Merchant | å®Œå…¨å…¼å®¹ |
| `transactions` | âœ… Transaction | å®Œå…¨å…¼å®¹ |
| `app_sessions` | âœ… Session | å®Œå…¨å…¼å®¹ |
| `card_qr_state` | âœ… QRCode | å®Œå…¨å…¼å®¹ |
| `point_ledger` | âœ… PointLedger | å®Œå…¨å…¼å®¹ |
| `settlements` | âš ï¸ Settlement | éœ€å¯¦ç¾ |

---

### æšèˆ‰é¡å‹ âœ…

| æšèˆ‰é¡å‹ | å¸¸é‡å®šç¾© | ç‹€æ…‹ |
|---------|---------|------|
| `card_type` | âœ… CARD_TYPES | å®Œå…¨å…¼å®¹ |
| `card_status` | âœ… CARD_STATUS | å®Œå…¨å…¼å®¹ |
| `tx_type` | âœ… TX_TYPES | å®Œå…¨å…¼å®¹ |
| `tx_status` | âœ… TX_STATUS | å®Œå…¨å…¼å®¹ |
| `bind_role` | âœ… BIND_ROLES | å®Œå…¨å…¼å®¹ |
| `pay_method` | âœ… PAY_METHODS | å®Œå…¨å…¼å®¹ |
| `settlement_mode` | âš ï¸ éœ€æ·»åŠ  | å¾…å¯¦ç¾ |

---

## ğŸ¯ éœ€è¦æ”¹é€²çš„åœ°æ–¹

### 1. çµç®—åŠŸèƒ½ (å„ªå…ˆç´š: P1)

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ ç”Ÿæˆçµç®—å ±è¡¨ UI
- âŒ æŸ¥çœ‹çµç®—æ­·å² UI
- âŒ Settlement Model

**éœ€è¦æ·»åŠ **:
```python
# models/settlement.py
@dataclass
class Settlement(BaseModel):
    merchant_id: str
    settlement_mode: str
    period_start: str
    period_end: str
    total_amount: Decimal
    # ... å…¶ä»–å­—æ®µ
```

**éœ€è¦å¯¦ç¾ UI**:
```python
# ui/merchant_ui.py
def _generate_settlement(self):
    """ç”Ÿæˆçµç®—å ±è¡¨"""
    # å¯¦ç¾çµç®—å ±è¡¨ç”Ÿæˆ

def _view_settlement_history(self):
    """æŸ¥çœ‹çµç®—æ­·å²"""
    # å¯¦ç¾çµç®—æ­·å²æŸ¥çœ‹
```

---

### 2. Admin UI å®Œå–„ (å„ªå…ˆç´š: P1)

**éœ€è¦æª¢æŸ¥çš„åŠŸèƒ½**:
- âš ï¸ å‰µå»ºå•†æˆ¶æµç¨‹
- âš ï¸ å‰µå»ºä¼æ¥­å¡æµç¨‹
- âš ï¸ å‰µå»ºå„ªæƒ åˆ¸å¡æµç¨‹
- âš ï¸ å¡ç‰‡ç®¡ç†åŠŸèƒ½
- âš ï¸ æœƒå“¡ç®¡ç†åŠŸèƒ½

**å»ºè­°**: é€å€‹æª¢æŸ¥ä¸¦ç¢ºä¿èˆ‡æœ€æ–° RPC å°æ¥æ­£ç¢º

---

### 3. å¸¸é‡å®šç¾©è£œå…… (å„ªå…ˆç´š: P2)

**éœ€è¦æ·»åŠ **:
```python
# config/constants.py

# çµç®—æ¨¡å¼
SETTLEMENT_MODES = {
    'realtime': 'å¯¦æ™‚çµç®—',
    't_plus_1': 'T+1çµç®—',
    'monthly': 'æœˆçµ'
}
```

---

## âœ… ç¸½é«”è©•ä¼°

### å…¼å®¹æ€§è©•åˆ†: **90/100**

**å„ªé»**:
- âœ… æ ¸å¿ƒåŠŸèƒ½èˆ‡ Schema/RPC å®Œå…¨å…¼å®¹
- âœ… æœƒå“¡ç«¯å’Œå•†æˆ¶ç«¯ä¸»è¦åŠŸèƒ½å·²å•†æ¥­åŒ–æ”¹å¯«
- âœ… Models å’Œ Utils è¨­è¨ˆè‰¯å¥½
- âœ… RPC å°æ¥æ­£ç¢º

**éœ€æ”¹é€²**:
- âš ï¸ çµç®—åŠŸèƒ½å°šæœªå¯¦ç¾ (-5åˆ†)
- âš ï¸ Admin UI éœ€è¦æª¢æŸ¥æ›´æ–° (-5åˆ†)

---

## ğŸ“‹ è¡Œå‹•è¨ˆåŠƒ

### ç«‹å³åŸ·è¡Œ (P0)
- âœ… ç„¡ï¼Œæ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ

### çŸ­æœŸè¨ˆåŠƒ (P1)
1. **å¯¦ç¾çµç®—åŠŸèƒ½** (é è¨ˆ 2-3 å°æ™‚)
   - å‰µå»º Settlement Model
   - å¯¦ç¾ç”Ÿæˆçµç®—å ±è¡¨ UI
   - å¯¦ç¾æŸ¥çœ‹çµç®—æ­·å² UI

2. **æª¢æŸ¥ Admin UI** (é è¨ˆ 1-2 å°æ™‚)
   - æª¢æŸ¥æ‰€æœ‰ç®¡ç†åŠŸèƒ½
   - ç¢ºä¿èˆ‡æœ€æ–° RPC å°æ¥
   - å„ªåŒ–ç”¨æˆ¶é«”é©—

### é•·æœŸè¨ˆåŠƒ (P2)
1. **æ·»åŠ æ›´å¤šå·¥å…·å‡½æ•¸** (å¯é¸)
2. **å„ªåŒ–æ€§èƒ½** (å¯é¸)
3. **æ·»åŠ æ›´å¤šé©—è­‰** (å¯é¸)

---

## ğŸ‰ çµè«–

**ç¸½é«”ç‹€æ…‹**: âœ… **è‰¯å¥½**

CLI ä»£ç¢¼èˆ‡æœ€æ–°çš„ Schema å’Œ RPC åŸºæœ¬å…¼å®¹ï¼Œæ ¸å¿ƒåŠŸèƒ½å·²ç¶“å®Œæˆå•†æ¥­åŒ–æ”¹å¯«ã€‚ä¸»è¦ç¼ºå¤±çš„æ˜¯çµç®—åŠŸèƒ½å’Œéƒ¨åˆ†ç®¡ç†åŠŸèƒ½ï¼Œé€™äº›å¯ä»¥ä½œç‚ºä¸‹ä¸€éšæ®µçš„é–‹ç™¼é‡é»ã€‚

**å»ºè­°**:
1. å„ªå…ˆå¯¦ç¾çµç®—åŠŸèƒ½ï¼ˆå•†æˆ¶ç«¯é‡è¦åŠŸèƒ½ï¼‰
2. æª¢æŸ¥ä¸¦å®Œå–„ Admin UI
3. å…¶ä»–åŠŸèƒ½å¯ä»¥æ ¹æ“šå¯¦éš›éœ€æ±‚é€æ­¥å®Œå–„

---

**æœ€å¾Œæ›´æ–°**: 2025-10-01 21:30  
**æª¢æŸ¥äºº**: AI Assistant  
**å…¼å®¹æ€§**: 90%
