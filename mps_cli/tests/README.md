# MPS æ¸¬è©¦å¥—ä»¶

å®Œæ•´çš„ Member Payment System (MPS) åŠŸèƒ½æ¸¬è©¦å¥—ä»¶ï¼Œæ¶µè“‹æ‰€æœ‰ super_admin åŠŸèƒ½ã€‚

## ğŸ“‹ æ¸¬è©¦æ¦‚è¿°

æœ¬æ¸¬è©¦å¥—ä»¶åŸºæ–¼ç¾æœ‰çš„ [`test_member_password.py`](../test_member_password.py:1) é¢¨æ ¼è¨­è¨ˆï¼Œæä¾›å®Œæ•´çš„æ¥­å‹™æµç¨‹æ¸¬è©¦ã€‚

### æ¸¬è©¦è¦†è“‹ç¯„åœ

- âœ… **æœƒå“¡ç®¡ç†**: å‰µå»ºã€ç™»å…¥ã€æœå°‹ã€æš«åœã€å¯†ç¢¼ç®¡ç†
- âœ… **å¡ç‰‡ç®¡ç†**: æŸ¥è©¢ã€å‡çµ/è§£å‡ã€ç¶å®š/è§£ç¶
- âœ… **QR ç¢¼ç®¡ç†**: ç”Ÿæˆã€é©—è­‰ã€æ’¤éŠ·ã€æ‰¹é‡è¼ªæ›
- âœ… **æ”¯ä»˜æµç¨‹**: æƒç¢¼æ”¯ä»˜ã€æŠ˜æ‰£è¨ˆç®—ã€ç©åˆ†ç´¯ç©ã€å¹‚ç­‰æ€§
- âœ… **é€€æ¬¾æµç¨‹**: å…¨é¡é€€æ¬¾ã€éƒ¨åˆ†é€€æ¬¾ã€å¤šæ¬¡é€€æ¬¾
- âœ… **å……å€¼æµç¨‹**: ä¸åŒæ”¯ä»˜æ–¹å¼ã€å¹‚ç­‰æ€§é©—è­‰
- âœ… **ç©åˆ†å’Œç­‰ç´š**: è‡ªå‹•ç´¯ç©ã€è‡ªå‹•å‡ç´šã€æ‰‹å‹•èª¿æ•´
- âœ… **å•†æˆ¶ç®¡ç†**: å‰µå»ºã€æŸ¥è©¢ã€æš«åœ
- âœ… **çµç®—ç®¡ç†**: ç”Ÿæˆçµç®—ã€æŸ¥è©¢çµç®—
- âœ… **å®Œæ•´æ¥­å‹™æµç¨‹**: ç«¯åˆ°ç«¯æ¸¬è©¦

## ğŸš€ å¿«é€Ÿé–‹å§‹

### å‰ç½®æ¢ä»¶

1. å·²é…ç½® `.env` æ–‡ä»¶
2. æ“æœ‰ super_admin æˆ– admin æ¬Šé™çš„å¸³è™Ÿ
3. å·²å®‰è£æ‰€æœ‰ä¾è³´ï¼š`pip install -r requirements.txt`

### é‹è¡Œæ¸¬è©¦

```bash
# é€²å…¥æ¸¬è©¦ç›®éŒ„
cd mps_cli/test_suite

# é‹è¡Œå®Œæ•´æ¥­å‹™æµç¨‹æ¸¬è©¦ï¼ˆæ¨è–¦å…ˆé‹è¡Œæ­¤æ¸¬è©¦ï¼‰
python test_complete_business_flow.py

# é‹è¡Œæœƒå“¡å¯†ç¢¼æ¸¬è©¦ï¼ˆå¾æ ¹ç›®éŒ„ç§»éä¾†çš„ï¼‰
python test_member_password.py

# é‹è¡ŒåŸºç¤åŠŸèƒ½æ¸¬è©¦
python test_basic.py
```

## ğŸ“ æ¸¬è©¦æ–‡ä»¶èªªæ˜

### æ ¸å¿ƒæ¸¬è©¦æ–‡ä»¶

| æ–‡ä»¶ | èªªæ˜ | æ¸¬è©¦å…§å®¹ |
|------|------|----------|
| [`test_helpers.py`](test_helpers.py:1) | å…±äº«è¼”åŠ©å‡½æ•¸ | èªè­‰ã€æ•¸æ“šç”Ÿæˆã€æ¸…ç†ç­‰å·¥å…·å‡½æ•¸ |
| [`test_complete_business_flow.py`](test_complete_business_flow.py:1) | å®Œæ•´æ¥­å‹™æµç¨‹æ¸¬è©¦ | æ”¯ä»˜æµç¨‹ã€é€€æ¬¾æµç¨‹ã€å¡ç‰‡ç¶å®šæµç¨‹ |
| [`test_member_password.py`](test_member_password.py:1) | æœƒå“¡å¯†ç¢¼åŠŸèƒ½æ¸¬è©¦ | å‰µå»ºæœƒå“¡ã€ç™»å…¥ã€æœå°‹ |
| [`test_basic.py`](test_basic.py:1) | åŸºç¤åŠŸèƒ½æ¸¬è©¦ | æ¨¡çµ„å°å…¥ã€é©—è­‰å™¨ã€æ ¼å¼åŒ–å™¨ |

### è¦åŠƒä¸­çš„æ¸¬è©¦æ–‡ä»¶

ä»¥ä¸‹æ¸¬è©¦æ–‡ä»¶å·²åœ¨ [`TEST_PLAN.md`](TEST_PLAN.md:1) ä¸­è¦åŠƒï¼Œå¯æ ¹æ“šéœ€è¦å¯¦ç¾ï¼š

- `test_01_member_management.py` - æœƒå“¡ç®¡ç†å®Œæ•´æ¸¬è©¦
- `test_02_card_management.py` - å¡ç‰‡ç®¡ç†å®Œæ•´æ¸¬è©¦
- `test_03_card_binding.py` - å¡ç‰‡ç¶å®šå®Œæ•´æ¸¬è©¦
- `test_04_qr_management.py` - QR ç¢¼ç®¡ç†å®Œæ•´æ¸¬è©¦
- `test_05_payment_flow.py` - æ”¯ä»˜æµç¨‹å®Œæ•´æ¸¬è©¦
- `test_06_refund_flow.py` - é€€æ¬¾æµç¨‹å®Œæ•´æ¸¬è©¦
- `test_07_recharge_flow.py` - å……å€¼æµç¨‹å®Œæ•´æ¸¬è©¦
- `test_08_points_and_levels.py` - ç©åˆ†å’Œç­‰ç´šå®Œæ•´æ¸¬è©¦
- `test_09_merchant_management.py` - å•†æˆ¶ç®¡ç†å®Œæ•´æ¸¬è©¦
- `test_10_settlement.py` - çµç®—å®Œæ•´æ¸¬è©¦

## ğŸ”§ æ¸¬è©¦è¼”åŠ©å‡½æ•¸

[`test_helpers.py`](test_helpers.py:1) æä¾›äº†è±å¯Œçš„è¼”åŠ©å‡½æ•¸ï¼š

### èªè­‰ç›¸é—œ
- `setup_admin_auth()` - è¨­å®šç®¡ç†å“¡èªè­‰
- `cleanup_all_test_data()` - æ¸…ç†æ‰€æœ‰æ¸¬è©¦æ•¸æ“š

### æ•¸æ“šç”Ÿæˆ
- `generate_test_member_data()` - ç”Ÿæˆæ¸¬è©¦æœƒå“¡æ•¸æ“š
- `generate_test_merchant_data()` - ç”Ÿæˆæ¸¬è©¦å•†æˆ¶æ•¸æ“š

### å¿«æ·æ“ä½œ
- `create_test_member()` - å‰µå»ºæ¸¬è©¦æœƒå“¡
- `create_test_merchant()` - å‰µå»ºæ¸¬è©¦å•†æˆ¶
- `recharge_card()` - å……å€¼å¡ç‰‡
- `generate_qr_code()` - ç”Ÿæˆ QR ç¢¼
- `make_payment()` - åŸ·è¡Œæ”¯ä»˜
- `make_refund()` - åŸ·è¡Œé€€æ¬¾

### æŸ¥è©¢å‡½æ•¸
- `get_member_default_card()` - ç²å–æœƒå“¡é»˜èªå¡ç‰‡
- `get_card_balance()` - ç²å–å¡ç‰‡é¤˜é¡
- `get_card_points()` - ç²å–å¡ç‰‡ç©åˆ†

### è¼¸å‡ºæ ¼å¼åŒ–
- `print_test_header()` - æ‰“å°æ¸¬è©¦æ¨™é¡Œ
- `print_test_step()` - æ‰“å°æ¸¬è©¦æ­¥é©Ÿ
- `print_test_info()` - æ‰“å°æ¸¬è©¦ä¿¡æ¯
- `print_test_result()` - æ‰“å°æ¸¬è©¦çµæœ
- `print_test_summary()` - æ‰“å°æ¸¬è©¦ç¸½çµ

## ğŸ“ æ¸¬è©¦ç·¨å¯«æŒ‡å—

### åŸºæœ¬çµæ§‹

```python
#!/usr/bin/env python3
"""
æ¸¬è©¦æ–‡ä»¶èªªæ˜
"""

import sys
from pathlib import Path

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from test_helpers import (
    setup_admin_auth,
    cleanup_all_test_data,
    print_test_header,
    # ... å…¶ä»–éœ€è¦çš„å‡½æ•¸
)

def test_your_feature(auth_service):
    """æ¸¬è©¦ä½ çš„åŠŸèƒ½"""
    print_test_header("æ¸¬è©¦åç¨±")
    
    try:
        # æ¸¬è©¦æ­¥é©Ÿ
        print_test_step("æ­¥é©Ÿ 1: ...")
        # ... æ¸¬è©¦é‚è¼¯
        
        print_test_result("æ¸¬è©¦åç¨±", True, "æ¸¬è©¦é€šé")
        return True
        
    except Exception as e:
        print_test_result("æ¸¬è©¦åç¨±", False, str(e))
        return False

def main(auth_service=None):
    """ä¸»æ¸¬è©¦å‡½æ•¸"""
    if auth_service is None:
        auth_service = setup_admin_auth()
    
    results = {}
    
    try:
        results["æ¸¬è©¦1"] = test_your_feature(auth_service)
        # ... æ›´å¤šæ¸¬è©¦
        
        return print_test_summary(results)
        
    finally:
        cleanup_all_test_data(auth_service)

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
```

### æ¸¬è©¦æ•¸æ“šç®¡ç†

æ‰€æœ‰æ¸¬è©¦æ•¸æ“šæœƒè‡ªå‹•è¿½è¹¤ä¸¦åœ¨æ¸¬è©¦çµæŸå¾Œæ¸…ç†ï¼š

```python
# å‰µå»ºæœƒå“¡ï¼ˆè‡ªå‹•è¿½è¹¤ï¼‰
member_id, member_data = create_test_member(auth_service)

# å‰µå»ºå•†æˆ¶ï¼ˆè‡ªå‹•è¿½è¹¤ï¼‰
merchant_id, merchant_data = create_test_merchant(auth_service)

# æ¸¬è©¦çµæŸå¾Œè‡ªå‹•æ¸…ç†
cleanup_all_test_data(auth_service)
```

## âš ï¸ æ³¨æ„äº‹é …

1. **ç®¡ç†å“¡æ¬Šé™**: æ‰€æœ‰æ¸¬è©¦éƒ½éœ€è¦ `super_admin` æˆ– `admin` æ¬Šé™
2. **æ•¸æ“šæ¸…ç†**: æ¸¬è©¦æœƒè‡ªå‹•æ¸…ç†æ•¸æ“šï¼ˆä½¿ç”¨ `admin_suspend_*` RPCï¼‰
3. **æ¸¬è©¦ç’°å¢ƒ**: å»ºè­°åœ¨é–‹ç™¼æ•¸æ“šåº«ä¸­é‹è¡Œæ¸¬è©¦
4. **æ¸¬è©¦é †åº**: å»ºè­°å…ˆé‹è¡Œ `test_complete_business_flow.py` é©—è­‰æ ¸å¿ƒåŠŸèƒ½
5. **éŒ¯èª¤è™•ç†**: æ¸¬è©¦å¤±æ•—ä¸æœƒä¸­æ–·å¾ŒçºŒæ¸¬è©¦
6. **æ—¥èªŒè¨˜éŒ„**: æ‰€æœ‰æ“ä½œéƒ½æœƒè¨˜éŒ„åˆ°æ—¥èªŒæ–‡ä»¶

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

**Q: æ¸¬è©¦æç¤º "éœ€è¦ç®¡ç†å“¡æ¬Šé™"**
- A: ç¢ºä¿ä½¿ç”¨çš„å¸³è™Ÿå…·æœ‰ `super_admin` æˆ– `admin` è§’è‰²

**Q: æ¸¬è©¦æ•¸æ“šæ²’æœ‰æ¸…ç†**
- A: æª¢æŸ¥ `cleanup_all_test_data()` æ˜¯å¦åœ¨ `finally` å¡Šä¸­åŸ·è¡Œ

**Q: RPC èª¿ç”¨å¤±æ•—**
- A: æª¢æŸ¥ `.env` é…ç½®å’Œæ•¸æ“šåº«é€£æ¥

**Q: å‰µå»ºå•†æˆ¶å¤±æ•—**
- A: ç¢ºä¿ RPC å‡½æ•¸ `create_merchant` å·²åœ¨æ•¸æ“šåº«ä¸­å®šç¾©

## ğŸ“Š æ¸¬è©¦å ±å‘Š

æ¸¬è©¦åŸ·è¡Œå¾Œæœƒé¡¯ç¤ºè©³ç´°çš„æ¸¬è©¦å ±å‘Šï¼š

```
============================================================
æ¸¬è©¦ç¸½çµ
============================================================
å®Œæ•´æ”¯ä»˜æµç¨‹: âœ… é€šé
å®Œæ•´é€€æ¬¾æµç¨‹: âœ… é€šé
å¡ç‰‡ç¶å®šæµç¨‹: âœ… é€šé

ç¸½è¨ˆ: 3/3 é€šé

ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼
```

## ğŸ”— ç›¸é—œæ–‡æª”

- [`TEST_PLAN.md`](TEST_PLAN.md:1) - å®Œæ•´æ¸¬è©¦è¨ˆåŠƒ
- [`../README.md`](../README.md:1) - MPS CLI ä¸»æ–‡æª”
- [`../../README_BZ_FLOW.md`](../../README_BZ_FLOW.md:1) - æ¥­å‹™æµç¨‹èªªæ˜
- [`../../schema/mps_schema.sql`](../../schema/mps_schema.sql:1) - æ•¸æ“šåº«æ¶æ§‹
- [`../../rpc/mps_rpc.sql`](../../rpc/mps_rpc.sql:1) - RPC å‡½æ•¸å®šç¾©

## ğŸ“ˆ æ¸¬è©¦è¦†è“‹é€²åº¦

- [x] æ¸¬è©¦åŸºç¤è¨­æ–½ï¼ˆtest_helpers.pyï¼‰
- [x] å®Œæ•´æ¥­å‹™æµç¨‹æ¸¬è©¦
- [x] æœƒå“¡å¯†ç¢¼åŠŸèƒ½æ¸¬è©¦
- [x] åŸºç¤åŠŸèƒ½æ¸¬è©¦
- [ ] æœƒå“¡ç®¡ç†å®Œæ•´æ¸¬è©¦
- [ ] å¡ç‰‡ç®¡ç†å®Œæ•´æ¸¬è©¦
- [ ] QR ç¢¼ç®¡ç†å®Œæ•´æ¸¬è©¦
- [ ] æ”¯ä»˜æµç¨‹å®Œæ•´æ¸¬è©¦
- [ ] é€€æ¬¾æµç¨‹å®Œæ•´æ¸¬è©¦
- [ ] å……å€¼æµç¨‹å®Œæ•´æ¸¬è©¦
- [ ] ç©åˆ†å’Œç­‰ç´šå®Œæ•´æ¸¬è©¦
- [ ] å•†æˆ¶ç®¡ç†å®Œæ•´æ¸¬è©¦
- [ ] çµç®—ç®¡ç†å®Œæ•´æ¸¬è©¦

## ğŸ¤ è²¢ç»æŒ‡å—

å¦‚éœ€æ·»åŠ æ–°æ¸¬è©¦ï¼š

1. åƒè€ƒç¾æœ‰æ¸¬è©¦æ–‡ä»¶çµæ§‹
2. ä½¿ç”¨ `test_helpers.py` ä¸­çš„è¼”åŠ©å‡½æ•¸
3. ç¢ºä¿æ¸¬è©¦æ•¸æ“šæœƒè¢«è‡ªå‹•æ¸…ç†
4. æ·»åŠ æ¸…æ™°çš„æ¸¬è©¦èªªæ˜å’Œæ­¥é©Ÿ
5. æ›´æ–°æœ¬ README çš„æ¸¬è©¦è¦†è“‹é€²åº¦

## ğŸ“ æ”¯æŒ

å¦‚æœ‰å•é¡Œï¼Œè«‹æŸ¥çœ‹ï¼š
- æ¸¬è©¦æ—¥èªŒæ–‡ä»¶
- RPC å‡½æ•¸å®šç¾©
- æ¥­å‹™æµç¨‹æ–‡æª”

---

**æœ€å¾Œæ›´æ–°**: 2025-09-30
**ç‰ˆæœ¬**: 1.0.0